<form class="{{cssClass}}" autocomplete="off">
    
    {{!-- ================= ШАПКА ================= --}}
    <header class="sheet-header">
        <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}"/>
        
        <div class="header-fields">
            <div class="header-top">
                <div class="charname">
                    <input name="name" type="text" value="{{actor.name}}" placeholder="Имя Персонажа"/>
                </div>
                
                <div class="level-container">
                    <div class="level-display">
                        УРОВЕНЬ: <span>{{system.resources.level}}</span>
                        {{#if isGM}}
                            <span class="vis-btn" data-key="xp">
                                <i class="fas {{#if revealed.xp}}fa-eye{{else}}fa-eye-slash hidden{{/if}}"></i>
                            </span>
                        {{/if}}
                    </div>
                    
                    {{#if isGM}}
                        <div class="xp-bar-container">
                            <div class="xp-fill" style="width: {{xpPercent}}%;"></div>
                            <div class="xp-text">
                                {{system.resources.xp.value}} / {{system.resources.xp.max}}
                                <a class="xp-add-btn" title="Добавить XP">+</a>
                            </div>
                        </div>
                    {{else}}
                        {{#if revealed.xp}}
                            <div class="xp-bar-container" title="{{system.resources.xp.value}} / {{system.resources.xp.max}} XP">
                                <div class="xp-fill" style="width: {{xpPercent}}%;"></div>
                                <div class="xp-text">{{xpPercent}}%</div>
                            </div>
                        {{else}}
                            <div style="font-size:10px; color:#555; text-align:right;">XP Скрыт</div>
                        {{/if}}
                    {{/if}}
                </div>
            </div>

            <div class="resources-grid">
                {{!-- HP --}}
                <div class="res-box">
                    <label>Здоровье (HP)</label>
                    <div class="res-bar">
                        <div class="res-fill" style="width:{{hpPercent}}%; background:#800;"></div>
                        <div class="res-val">
                            {{#if isGM}}
                                <input type="number" name="system.resources.hp.value" value="{{system.resources.hp.value}}"/> / {{system.resources.hp.max}}
                            {{else}}
                                {{hpPercent}}%
                            {{/if}}
                        </div>
                    </div>
                </div>
                
                {{!-- Дух --}}
                <div class="res-box">
                    <label>Дух (Мана)</label>
                    <div class="res-bar">
                        <div class="res-fill" style="width:{{manaPercent}}%; background:#006;"></div>
                        <div class="res-val">
                            {{#if isGM}}
                                <input type="number" name="system.resources.mana.value" value="{{system.resources.mana.value}}"/> / {{system.resources.mana.max}}
                            {{else}}
                                {{manaPercent}}%
                            {{/if}}
                        </div>
                    </div>
                </div>
                
                {{!-- Камни Маны (Калькулятор) --}}
                <div class="res-box">
                    <label>Камни Маны</label>
                    <div class="currency-widget">
                        <div class="currency-display">{{system.resources.currency}}</div>
                        {{#if (or isGM owner)}}
                        <div class="currency-input-wrapper">
                            <input type="text" class="currency-input" placeholder="+ / -"/>
                        </div>
                        {{/if}}
                    </div>
                </div>
            </div>
        </div>
    </header>

    {{!-- ================= НАВИГАЦИЯ ================= --}}
    <nav class="sheet-tabs tabs" data-group="primary">
        <a class="item" data-tab="attributes">Характеристики</a>
        
        {{!-- Магия (только для магов и ГМ) --}}
        {{#if showSpellsTab}}
            <a class="item" data-tab="spells">Заклинания</a>
        {{/if}}
        
        {{!-- Контракты (Зверолюди, Эльфы) --}}
        {{#if showContractsTab}}
            <a class="item" data-tab="contracts">Контракты</a>
        {{/if}}
        
        <a class="item" data-tab="combat">Бой</a>
        <a class="item" data-tab="inventory">Инвентарь</a>
        <a class="item" data-tab="blessings">Благословения</a>
        <a class="item" data-tab="biography">Биография</a>
    </nav>

    {{!-- ================= ТЕЛО ЛИСТА ================= --}}
    <section class="sheet-body">
        
        {{!-- === ВКЛАДКА: ХАРАКТЕРИСТИКИ === --}}
        <div class="tab attributes" data-group="primary" data-tab="attributes">
            <div class="sheet-body grid-2col">
                
                {{!-- ЛЕВАЯ КОЛОНКА --}}
                <div class="column">
                    {{!-- Базовые атрибуты --}}
                    <div class="panel">
                        <h3>Базовые Атрибуты</h3>
                        <div class="big-stats-row">
                            <div class="big-stat">
                                {{#if isGM}}
                                    <div class="vis-btn" data-key="physique">
                                        <i class="fas {{#if revealed.physique}}fa-eye{{else}}fa-eye-slash hidden{{/if}}"></i>
                                    </div>
                                {{/if}}
                                <label class="rollable" data-key="physique" data-label="Телосложение">Тело</label>
                                {{#if isGM}}
                                    <input type="number" name="system.attributes.physique" value="{{system.attributes.physique}}"/>
                                {{else}}
                                    <div class="stat-value-box {{#unless revealed.physique}}dimmed{{/unless}}">
                                        {{#if revealed.physique}}{{system.attributes.physique}}{{else}}?{{/if}}
                                    </div>
                                {{/if}}
                            </div>
                            
                            <div class="big-stat">
                                {{#if isGM}}
                                    <div class="vis-btn" data-key="spirit">
                                        <i class="fas {{#if revealed.spirit}}fa-eye{{else}}fa-eye-slash hidden{{/if}}"></i>
                                    </div>
                                {{/if}}
                                <label class="rollable" data-key="spirit" data-label="Дух">Дух</label>
                                {{#if isGM}}
                                    <input type="number" name="system.attributes.spirit" value="{{system.attributes.spirit}}"/>
                                {{else}}
                                    <div class="stat-value-box {{#unless revealed.spirit}}dimmed{{/unless}}">
                                        {{#if revealed.spirit}}{{system.attributes.spirit}}{{else}}?{{/if}}
                                    </div>
                                {{/if}}
                            </div>
                        </div>
                    </div>

                    {{!-- ДУХ --}}
                    <div class="panel">
                        <h3>
                            Дух
                            <button class="meditation-btn regen-btn" type="button"><i class="fas fa-star"></i> Медитация</button>
                        </h3>
                        
                        {{!-- Исследование и Разум --}}
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="intuition" label="Интуиция (Чутье)" val=system.subAttributes.intuition sourceVal=sourceSystem.subAttributes.intuition visible=revealed.intuition isGM=isGM}}
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="cognition" label="Когнитивность (Ум)" val=system.subAttributes.cognition sourceVal=sourceSystem.subAttributes.cognition visible=revealed.cognition isGM=isGM}}
                        
                        {{!-- Социалка и Защита --}}
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="presence" label="Присутствие (Соц)" val=system.subAttributes.presence sourceVal=sourceSystem.subAttributes.presence visible=revealed.presence isGM=isGM}}
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="willpower" label="Воля (Ментал. Деф)" val=system.subAttributes.willpower sourceVal=sourceSystem.subAttributes.willpower visible=revealed.willpower isGM=isGM}}
                        
                        {{!-- Магия --}}
                        <hr style="border-color:#333;">
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="magicResistance" label="Маг. Сопр." val=system.subAttributes.magicResistance sourceVal=sourceSystem.subAttributes.magicResistance visible=revealed.magicResistance isGM=isGM}}
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="manaSensitivity" label="Чувств. Маны" val=system.subAttributes.manaSensitivity sourceVal=sourceSystem.subAttributes.manaSensitivity visible=revealed.manaSensitivity isGM=isGM}}
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="spiritRecovery" label="Восст. Духа" val=system.subAttributes.spiritRecovery sourceVal=sourceSystem.subAttributes.spiritRecovery visible=revealed.spiritRecovery isGM=isGM}}
                        
                        {{!-- ДРАКОНЫ: СИЛА ДРАКОНА (Тоже обновлено) --}}
                        {{#if race.isDragon}}
                        <div class="stat-row" style="border-top: 1px solid #522; margin-top:5px;">
                            {{#if isGM}}
                                <div class="vis-btn" data-key="dragonPower"><i class="fas {{#if revealed.dragonPower}}fa-eye{{else}}fa-eye-slash hidden{{/if}}"></i></div>
                            {{else}}<div class="vis-icon"></div>{{/if}}
                            <div class="stat-name rollable" data-key="dragonPower" data-label="Сила Дракона" style="color:#f88;">Сила Дракона</div>
                            {{#if isGM}}
                                <input type="number" name="system.dragonPower" value="{{sourceSystem.dragonPower}}"/>
                                {{#if (ne system.dragonPower sourceSystem.dragonPower)}}
                                    <span style="font-size:11px; color:#6bf; font-weight:bold;">({{system.dragonPower}})</span>
                                {{/if}}
                            {{else}}
                                <div class="stat-val-display">{{#if revealed.dragonPower}}{{system.dragonPower}}{{else}}?{{/if}}</div>
                            {{/if}}
                        </div>
                        {{/if}}
                    </div>

                    {{!-- РОДОСЛОВНАЯ (СЛОТ) --}}
                    <div class="panel">
                        <h3>
                            Родословная
                            {{#if isGM}}<a class="item-create" data-type="lineage" style="font-size:12px; float:right;">+</a>{{/if}}
                        </h3>
                        {{#if lineageItem}}
                            <div class="item-slot filled" data-item-id="{{lineageItem._id}}">
                                <img src="{{lineageItem.img}}"/>
                                <div class="slot-info">
                                    <span class="slot-name">{{lineageItem.name}}</span>
                                </div>
                                {{#if isGM}}
                                <div class="item-controls">
                                    <a class="item-edit"><i class="fas fa-edit"></i></a>
                                    <a class="item-delete"><i class="fas fa-trash"></i></a>
                                </div>
                                {{/if}}
                            </div>
                        {{else}}
                            <div class="item-slot empty"><span>Перетащите Родословную</span></div>
                        {{/if}}
                    </div>

                    {{!-- РОЛЬ (СЛОТ) --}}
                    <div class="panel">
                        <h3>
                            Роль (Класс)
                            {{#if isGM}}<a class="item-create" data-type="role" style="font-size:12px; float:right;">+</a>{{/if}}
                        </h3>
                        {{#if roleItem}}
                            <div class="item-slot filled" data-item-id="{{roleItem._id}}">
                                <img src="{{roleItem.img}}"/>
                                <div class="slot-info">
                                    <span class="slot-name">{{roleItem.name}}</span>
                                    <span class="slot-meta">Ранг {{roleItem.system.rank}}</span>
                                </div>
                                {{#if isGM}}
                                <div class="item-controls">
                                    <a class="item-edit"><i class="fas fa-edit"></i></a>
                                    <a class="item-delete"><i class="fas fa-trash"></i></a>
                                </div>
                                {{/if}}
                            </div>
                        {{else}}
                            <div class="item-slot empty"><span>Перетащите Класс</span></div>
                        {{/if}}
                    </div>

                    {{!-- СОПРОТИВЛЕНИЯ --}}
                    <div class="panel">
                        <h3>Сопротивления</h3>
                        <div style="font-size:11px; text-align:center; padding-bottom:5px; color:#aaa;">
                            База: Физ <b>{{system.resistances.physBase}}%</b> | Маг <b>{{system.resistances.magBase}}%</b>
                        </div>
                        
                        <div class="resist-grid">
                             {{#*inline "resistRowDirect"}}
                            <div class="resist-row">
                                {{#if isGM}}
                                    <div class="vis-btn" data-key="{{key}}">
                                        <i class="fas {{#if visible}}fa-eye{{else}}fa-eye-slash hidden{{/if}}"></i>
                                    </div>
                                {{else}}
                                    <div class="vis-icon"></div>
                                {{/if}}
                                <span class="{{#unless visible}}dimmed{{/unless}}">{{label}}</span>
                                {{#if isGM}}
                                    <input type="number" name="system.resistances.{{stat}}" value="{{val}}"/>
                                {{else}}
                                    <span>{{#if visible}}{{val}}{{else}}?{{/if}}</span>
                                {{/if}}
                            </div>
                            {{/inline}}

                            {{> resistRowDirect key="resist_slashing" stat="slashing" label="Рубящий" val=system.resistances.slashing visible=revealed.resist_slashing isGM=isGM}}
                            {{> resistRowDirect key="resist_blunt" stat="blunt" label="Дробящий" val=system.resistances.blunt visible=revealed.resist_blunt isGM=isGM}}
                            {{> resistRowDirect key="resist_piercing" stat="piercing" label="Колющий" val=system.resistances.piercing visible=revealed.resist_piercing isGM=isGM}}
                            {{> resistRowDirect key="resist_fire" stat="fire" label="Огонь" val=system.resistances.fire visible=revealed.resist_fire isGM=isGM}}
                            {{> resistRowDirect key="resist_cold" stat="cold" label="Холод" val=system.resistances.cold visible=revealed.resist_cold isGM=isGM}}
                            {{> resistRowDirect key="resist_lightning" stat="lightning" label="Молния" val=system.resistances.lightning visible=revealed.resist_lightning isGM=isGM}}
                            {{> resistRowDirect key="resist_poison" stat="poison" label="Яд" val=system.resistances.poison visible=revealed.resist_poison isGM=isGM}}
                            {{> resistRowDirect key="resist_acid" stat="acid" label="Кислота" val=system.resistances.acid visible=revealed.resist_acid isGM=isGM}}
                            {{> resistRowDirect key="resist_psychic" stat="psychic" label="Психика" val=system.resistances.psychic visible=revealed.resist_psychic isGM=isGM}}
                            {{> resistRowDirect key="resist_light" stat="light" label="Свет" val=system.resistances.light visible=revealed.resist_light isGM=isGM}}
                            {{> resistRowDirect key="resist_dark" stat="dark" label="Тьма" val=system.resistances.dark visible=revealed.resist_dark isGM=isGM}}
                            {{> resistRowDirect key="resist_pure" stat="pure" label="Чистый" val=system.resistances.pure visible=revealed.resist_pure isGM=isGM}}
                        </div>
                    </div>
                </div>

                {{!-- ПРАВАЯ КОЛОНКА --}}
                <div class="column">
                    <div class="panel">
                        <h3>
                            Тело
                            <button class="regen-btn" type="button" style="float:right;">
                                <i class="fas fa-heart"></i> Отдых
                            </button>
                        </h3>

                        {{!-- === СКОРОСТЬ И ИНИЦИАТИВА (НОВОЕ) === --}}
                        <div style="display: flex; gap: 5px; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #333;">
                            
                            {{!-- Инициатива (Кнопка) --}}
                            <button type="button" class="roll-initiative" style="flex: 1; background: #222; border: 1px solid #444; color: #d4af37; font-size: 12px; cursor: pointer;">
                                <i class="fas fa-bolt"></i> Инициатива
                            </button>

                            {{!-- Скорость (Умный инпут) --}}
                            <div class="stat-row" style="flex: 1; margin: 0; background: transparent; border: none; padding: 0;">
                                <div class="stat-name" style="text-align: right; margin-right: 5px;" title="Скорость перемещения">
                                    <i class="fas fa-person-running" style="font-size: 16px;"></i>
                                </div>
                                
                                {{#if isGM}}
                                    <div style="display: flex; align-items: center; justify-content: flex-end;">
                                        {{!-- Показываем бонус, если он есть --}}
                                        {{#if (ne system.attributes.speedBonus 0)}}
                                            <span class="mod-label">
                                                {{#if (gt system.attributes.speedBonus 0)}}+{{/if}}{{system.attributes.speedBonus}}
                                            </span>
                                        {{/if}}

                                        <div class="smart-input-wrapper">
                                            {{!-- Редактируем БОНУС --}}
                                            <input class="direct-edit" type="number" name="system.attributes.speedBonus" value="{{sourceSystem.attributes.speedBonus}}"/>
                                            {{!-- Видим ИТОГ --}}
                                            <div class="smart-overlay">{{system.attributes.speed}}</div>
                                        </div>
                                    </div>
                                {{else}}
                                    <div class="stat-val-display">{{system.attributes.speed}}</div>
                                {{/if}}
                            </div>
                        </div>
                        {{!-- ====================================== --}}
                        {{!-- Обновленные вызовы с sourceVal --}}
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="strength" label="Сила" val=system.subAttributes.strength sourceVal=sourceSystem.subAttributes.strength visible=revealed.strength isGM=isGM}}
                        
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="agility" label="Ловкость" val=system.subAttributes.agility sourceVal=sourceSystem.subAttributes.agility visible=revealed.agility isGM=isGM}}
                        
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="endurance" label="Выносливость" val=system.subAttributes.endurance sourceVal=sourceSystem.subAttributes.endurance visible=revealed.endurance isGM=isGM}}

                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="fortitude" label="Стойкость (Иммунитет)" val=system.subAttributes.fortitude sourceVal=sourceSystem.subAttributes.fortitude visible=revealed.fortitude isGM=isGM}}
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="metabolism" label="Метаболизм (Эфф. Еды)" val=system.subAttributes.metabolism sourceVal=sourceSystem.subAttributes.metabolism visible=revealed.metabolism isGM=isGM}}
                        
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="accuracy" label="Точность" val=system.subAttributes.accuracy sourceVal=sourceSystem.subAttributes.accuracy visible=revealed.accuracy isGM=isGM}}
                        
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="throwing" label="Метание" val=system.subAttributes.throwing sourceVal=sourceSystem.subAttributes.throwing visible=revealed.throwing isGM=isGM}}
                        
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="flexibility" label="Гибкость" val=system.subAttributes.flexibility sourceVal=sourceSystem.subAttributes.flexibility visible=revealed.flexibility isGM=isGM}}
                        
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="perception" label="Восприятие" val=system.subAttributes.perception sourceVal=sourceSystem.subAttributes.perception visible=revealed.perception isGM=isGM}}
                        
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="vision" label="Зрение" val=system.subAttributes.vision sourceVal=sourceSystem.subAttributes.vision visible=revealed.vision isGM=isGM}}
                        
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="boneDensity" label="Плотность Костей" val=system.subAttributes.boneDensity sourceVal=sourceSystem.subAttributes.boneDensity visible=revealed.boneDensity isGM=isGM}}
                        
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="naturalRegeneration" label="Ест. Регенерация" val=system.subAttributes.naturalRegeneration sourceVal=sourceSystem.subAttributes.naturalRegeneration visible=revealed.naturalRegeneration isGM=isGM}}
                        
                        {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="physicalResistance" label="Физ. Сопр. (Бонус)" val=system.subAttributes.physicalResistance sourceVal=sourceSystem.subAttributes.physicalResistance visible=revealed.physicalResistance isGM=isGM}}
                    </div>

                    {{!-- ВЛАДЕНИЕ ОРУЖИЕМ (Обновленный Inline Helper) --}}
                    <div class="panel" style="margin-top:10px;">
                        <h3>Владение Оружием</h3>
                        
                        {{#*inline "profRow"}}
                        <div class="stat-row">
                            {{#if isGM}}
                                <div class="vis-btn" data-key="{{key}}">
                                    <i class="fas {{#if visible}}fa-eye{{else}}fa-eye-slash hidden{{/if}}"></i>
                                </div>
                            {{else}}<div class="vis-icon"></div>{{/if}}
                            
                            <div class="stat-name {{#unless visible}}dimmed{{/unless}}">{{label}}</div>
                            
                            {{#if isGM}}
                                <div style="display: flex; align-items: center; justify-content: flex-end; width: 100%;">
                                    {{#if (ne val sourceVal)}}
                                        <span class="mod-label">
                                            {{#if (gt val sourceVal)}}+{{/if}}{{sub val sourceVal}}
                                        </span>
                                    {{/if}}
                                    <div class="smart-input-wrapper">
                                        {{!-- ДОБАВЛЕН КЛАСС: direct-edit --}}
                                        <input class="direct-edit" type="number" name="system.proficiencies.{{stat}}" value="{{sourceVal}}"/>
                                        <div class="smart-overlay">{{val}}</div>
                                    </div>
                                </div>
                            {{else}}
                                <div class="stat-val-display">{{#if visible}}{{val}}{{else}}?{{/if}}</div>
                            {{/if}}
                        </div>
                        {{/inline}}

                        {{!-- ВАЖНО: передаем sourceVal, используя ../sourceSystem --}}
                        {{> profRow key="prof_bladed" stat="bladed" label="Клинковое" val=system.proficiencies.bladed sourceVal=sourceSystem.proficiencies.bladed visible=revealed.prof_bladed isGM=isGM}}
                        {{> profRow key="prof_blunt" stat="blunt" label="Дробящее" val=system.proficiencies.blunt sourceVal=sourceSystem.proficiencies.blunt visible=revealed.prof_blunt isGM=isGM}}
                        {{> profRow key="prof_polearm" stat="polearm" label="Древковое" val=system.proficiencies.polearm sourceVal=sourceSystem.proficiencies.polearm visible=revealed.prof_polearm isGM=isGM}}
                        {{> profRow key="prof_axes" stat="axes" label="Топоры" val=system.proficiencies.axes sourceVal=sourceSystem.proficiencies.axes visible=revealed.prof_axes isGM=isGM}}
                        {{> profRow key="prof_unarmed" stat="unarmed" label="Безоружный" val=system.proficiencies.unarmed sourceVal=sourceSystem.proficiencies.unarmed visible=revealed.prof_unarmed isGM=isGM}}
                    </div>
                </div>
            </div>
        </div>
        
        {{!-- === ВКЛАДКА: ЗАКЛИНАНИЯ (Динамическая) === --}}
        {{#if showSpellsTab}}
        <div class="tab spells" data-group="primary" data-tab="spells">
            <div class="sheet-body">
                <div class="panel">
                     <h3>Книга Заклинаний</h3>
                     {{#if roleItem}}
                     <p style="font-size:12px; color:#aaa; margin-bottom:10px;">
                         Класс: <b style="color:#d4af37">{{roleItem.name}}</b> (Ранг {{roleItem.system.rank}})
                     </p>
                     <div class="grid-2col">
                         {{#each spellsByRank as |group|}}
                            {{#if group.visible}}
                                 <div class="inventory-section">
                                    <h4 style="border-bottom:1px solid #444; color:#aaddff; display:flex; justify-content:space-between;">
                                        Ранг {{group.rank}}
                                        {{#if ../isGM}}
                                            <a class="item-create" data-type="spell" data-rank="{{group.rank}}" style="color:#aaddff; cursor:pointer;">+</a>
                                        {{/if}}
                                    </h4>
                                    <ol class="items-list">
                                        {{#each group.list as |item|}}
                                        <li class="item item-entry" data-item-id="{{item._id}}" draggable="true">
                                            <img src="{{item.img}}"/>
                                            <div class="item-name">{{item.name}}</div>
                                            <div class="item-controls">
                                                <button class="ability-use" type="button" style="width:24px; padding:0; color:#aaddff;">
                                                    <i class="fas fa-magic"></i>
                                                </button>
                                                {{#if ../../isGM}}
                                                <a class="item-edit"><i class="fas fa-edit"></i></a>
                                                <a class="item-delete"><i class="fas fa-trash"></i></a>
                                                {{/if}}
                                            </div>
                                        </li>
                                        {{else}}
                                            <li style="font-style:italic; color:#555; font-size:10px; padding:2px;">Нет заклинаний</li>
                                        {{/each}}
                                    </ol>
                                 </div>
                             {{/if}}
                         {{/each}}
                     </div>
                     {{else}}
                        <div style="padding:20px; text-align:center; color:#777;">Нет класса</div>
                     {{/if}}
                </div>
            </div>
        </div>
        {{/if}}

                {{!-- === ВКЛАДКА: КОНТРАКТЫ === --}}
        {{#if showContractsTab}}
        <div class="tab contracts" data-group="primary" data-tab="contracts">
            <div class="panel">
                <h3>
                    Контракты Духов
                    {{#if isGM}}<a class="item-create" data-type="contract" style="float:right; font-size:12px;">+</a>{{/if}}
                </h3>
                <p style="font-size:11px; color:#aaa; margin-bottom:10px;">
                    Связь с духами природы, предками или стихиями.
                </p>
                
                <ol class="items-list">
                    {{#each contracts as |item|}}
                    <li class="item item-entry" data-item-id="{{item._id}}" draggable="true">
                        <img src="{{item.img}}"/>
                        <div class="item-name">
                            {{item.name}}
                            <span style="font-size:10px; color:#aaa;">({{item.system.contractType}})</span>
                        </div>
                        
                        <div class="item-controls">
                            {{!-- Кнопка для вывода условий контракта в чат --}}
                            <button class="ability-use" type="button" style="width:24px; padding:0; color:#aaddff;">
                                <i class="fas fa-scroll"></i>
                            </button>
                            
                            {{#if ../isGM}}
                            <a class="item-edit"><i class="fas fa-edit"></i></a>
                            <a class="item-delete"><i class="fas fa-trash"></i></a>
                            {{/if}}
                        </div>
                    </li>
                    {{else}}
                        <li class="item-slot empty">Нет активных контрактов</li>
                    {{/each}}
                </ol>
            </div>
        </div>
        {{/if}}

        {{!-- === ВКЛАДКА: БОЙ === --}}
        <div class="tab combat" data-group="primary" data-tab="combat">

            <div class="panel" style="margin-bottom:10px; border-color: #555;">
                <h3>Боевые параметры</h3>
                <div class="grid-3col">
                    {{!-- Щит --}}
                    <div class="form-group" style="text-align:center;">
                        <label>Щит</label>
                        <div>
                            {{!-- Переключатель --}}
                            <a class="vis-btn" data-key="shieldRaised" title="Поднять щит" style="width:30px; height:30px; line-height:30px;">
                                <i class="fas {{#if system.combat.shieldRaised}}fa-shield-alt{{else}}fa-shield{{/if}}" style="{{#if system.combat.shieldRaised}}color:#4f4{{else}}color:#555{{/if}}"></i>
                            </a>
                        </div>
                    </div>
                    
                    {{!-- Бонус щита (можно редактировать) --}}
                    <div class="form-group">
                        <label>Бонус Щита (КС)</label>
                        <input type="number" name="system.combat.shieldBonus" value="{{system.combat.shieldBonus}}" style="text-align:center;"/>
                    </div>
                    
                    {{!-- Размер --}}
                    <div class="form-group">
                        <label>Размер</label>
                        <select name="system.details.size" style="width:100%; background:#111; color:#fff;">
                            {{selectOptions config.sizes selected=system.details.size labelAttr="label"}}
                        </select>
                    </div>
                </div>
                
                {{!-- Штраф Защиты --}}
                <div class="form-group" style="margin-top:5px; border-top:1px solid #333; padding-top:5px;">
                    <label style="color:#f44;">Истощение Защиты (Штраф КУ)</label>
                    <input type="number" name="system.combat.defensePenalty" value="{{system.combat.defensePenalty}}" style="color:#f44; font-weight:bold;"/>
                    <p style="font-size:10px; color:#aaa;">Сбрасывается в начале хода.</p>
                </div>
            </div>
            
            {{!-- ЛЮДИ: АУРА --}}
            {{#if race.isHuman}}
            <div class="panel" style="border-color:#aaf; margin-bottom:10px;">
                <h3>Аура <input type="checkbox" name="system.aura.active" {{checked system.aura.active}} style="float:right"/></h3>
                <div class="grid-2col">
                    <div class="form-group">
                        <label>Уровень Ауры</label>
                        <input type="number" name="system.aura.level" value="{{system.aura.level}}"/>
                    </div>
                </div>
            </div>
            {{/if}}

            {{!-- ДРАКОНЫ: СЛОВА --}}
            {{#if race.isDragon}}
            <div class="panel" style="border-color:#f44; margin-bottom:10px;">
                <h3>Слова Дракона</h3>
                <div class="item-slot empty">Нет изученных Слов</div>
            </div>
            {{/if}}

            {{!-- ВАРВАРЫ: ОТПЕЧАТОК --}}
            {{#if race.isBarbarian}}
            <div class="panel" style="border-color:#d4af37; margin-bottom:10px;">
                <h3>Отпечаток</h3>
                <div class="grid-2col">
                    <div class="form-group"><label>Уровень</label><input type="number" name="system.imprint.level" value="{{system.imprint.level}}"/></div>
                    <div class="form-group"><label>Путь</label><input type="text" name="system.imprint.path" value="{{system.imprint.path}}"/></div>
                </div>
            </div>
            {{/if}}

            <div class="panel">
                <h3>Оружие</h3>
                <ol class="items-list">
                    {{#each weapons as |item|}}
                    <li class="item item-entry" data-item-id="{{item._id}}" draggable="true">
                        <img src="{{item.img}}"/>
                        <div class="item-name">
                            {{item.name}} 
                            <span style="font-size:10px; color:#777">({{item.system.damage}})</span>
                        </div>
                        <div class="item-controls">
                            <button class="weapon-roll" type="button" style="width:24px; padding:0;">
                                <i class="fas fa-crosshairs"></i>
                            </button>
                            {{#if ../isGM}}
                            <a class="item-edit"><i class="fas fa-edit"></i></a>
                            <a class="item-delete"><i class="fas fa-trash"></i></a>
                            {{/if}}
                        </div>
                    </li>
                    {{/each}}
                </ol>
            </div>
            
            <div class="panel" style="margin-top:10px;">
                <h3>Активные Способности (Эссенции)</h3>
                <ol class="items-list">
                    {{#each abilities as |item|}}
                    <li class="item item-entry" data-item-id="{{item._id}}" draggable="true">
                        <img src="{{item.img}}"/>
                        <div class="item-name">{{item.name}}</div>
                        <div class="item-controls">
                            <button class="ability-use" type="button" style="width:24px; padding:0;">
                                <i class="fas fa-magic"></i>
                            </button>
                            {{#if ../isGM}}
                            <a class="item-edit"><i class="fas fa-edit"></i></a>
                            {{/if}}
                        </div>
                    </li>
                    {{/each}}
                </ol>
            </div>
        </div>

        {{!-- === ВКЛАДКА: ИНВЕНТАРЬ === --}}
        <div class="tab inventory" data-group="primary" data-tab="inventory">
            <div class="sheet-body grid-2col">
                <div class="column">
                    <div class="inventory-section">
                        <h3>
                            Оружие
                            {{#if isGM}}<a class="item-create" data-type="weapon" style="color:#d4af37; cursor:pointer;">+</a>{{/if}}
                        </h3>
                        <ol class="items-list">
                            {{#each weapons as |item|}}
                            <li class="item item-entry" data-item-id="{{item._id}}" draggable="true">
                                <img src="{{item.img}}"/>
                                <span class="item-name">{{item.name}}</span>
                                {{#if ../isGM}}
                                <div class="item-controls">
                                    <a class="item-edit"><i class="fas fa-edit"></i></a>
                                    <a class="item-delete"><i class="fas fa-trash"></i></a>
                                </div>
                                {{/if}}
                            </li>
                            {{/each}}
                        </ol>
                    </div>

                    <div class="inventory-section">
                        <h3>
                            Снаряжение 
                            {{#if isGM}}<a class="item-create" data-type="armor" style="color:#d4af37; cursor:pointer;">+</a>{{/if}}
                        </h3>
                        <ol class="items-list">
                            {{#each armor as |item|}}
                            <li class="item item-entry" data-item-id="{{item._id}}" draggable="true">
                                <img src="{{item.img}}"/>
                                <span class="item-name">{{item.name}}</span>
                                {{#if ../isGM}}
                                <div class="item-controls">
                                    <a class="item-edit"><i class="fas fa-edit"></i></a>
                                    <a class="item-delete"><i class="fas fa-trash"></i></a>
                                </div>
                                {{/if}}
                            </li>
                            {{/each}}
                        </ol>
                    </div>

                    <div class="inventory-section">
                        <h3>
                            Расходники 
                            {{#if isGM}}<a class="item-create" data-type="consumable" style="color:#d4af37; cursor:pointer;">+</a>{{/if}}
                        </h3>
                        <ol class="items-list">
                            {{#each consumables as |item|}}
                            <li class="item item-entry" data-item-id="{{item._id}}" draggable="true">
                                <img src="{{item.img}}"/>
                                <span class="item-name">{{item.name}}</span>
                                {{#if ../isGM}}
                                <div class="item-controls">
                                    <a class="item-edit"><i class="fas fa-edit"></i></a>
                                    <a class="item-delete"><i class="fas fa-trash"></i></a>
                                </div>
                                {{/if}}
                            </li>
                            {{/each}}
                        </ol>
                    </div>
                </div>
                
                <div class="column">
                    <div class="inventory-section">
                        <h3>
                            Эссенции 
                            {{#if isGM}}<a class="item-create" data-type="essence" style="color:#d4af37; cursor:pointer;">+</a>{{/if}}
                        </h3>
                        {{#each essencesByRank as |rankItems rankNum|}}
                            {{#if rankItems.length}}
                            <div style="font-size:11px; color:#d4af37; border-bottom:1px solid #333; margin-top:5px;">
                                Ранг {{rankNum}}
                            </div>
                            <ol class="items-list">
                                {{#each rankItems as |item|}}
                                <li class="item item-entry" data-item-id="{{item._id}}" draggable="true">
                                    <img src="{{item.img}}"/>
                                    <span class="item-name">{{item.name}}</span>
                                    {{#if ../../isGM}}
                                    <div class="item-controls">
                                        <a class="item-edit"><i class="fas fa-edit"></i></a>
                                        <a class="item-delete"><i class="fas fa-trash"></i></a>
                                    </div>
                                    {{/if}}
                                </li>
                                {{/each}}
                            </ol>
                            {{/if}}
                        {{/each}}
                    </div>

                    <div class="inventory-section">
                        <h3>
                            Лут 
                            {{#if isGM}}<a class="item-create" data-type="loot" style="color:#d4af37; cursor:pointer;">+</a>{{/if}}
                        </h3>
                        <ol class="items-list">
                            {{#each loot as |item|}}
                            <li class="item item-entry" data-item-id="{{item._id}}" draggable="true">
                                <img src="{{item.img}}"/>
                                <span class="item-name">{{item.name}}</span>
                                {{#if ../isGM}}
                                <div class="item-controls">
                                    <a class="item-edit"><i class="fas fa-edit"></i></a>
                                    <a class="item-delete"><i class="fas fa-trash"></i></a>
                                </div>
                                {{/if}}
                            </li>
                            {{/each}}
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        {{!-- === ВКЛАДКА: БЛАГОСЛОВЕНИЯ === --}}
        <div class="tab blessings" data-group="primary" data-tab="blessings">
            {{#if race.isDwarf}}
            <div class="panel" style="border-color:#cd7f32; margin-bottom:10px;">
                <h3><i class="fas fa-hammer"></i> Благословение Оружия (Дварф)</h3>
                <p style="font-size:12px;">Уменьшена перезарядка нумерованных предметов.</p>
                <button type="button" class="ability-use" style="width:100%; margin-top:5px;">
                    Активировать Экстренное Восстановление
                </button>
            </div>
            {{/if}}

            <div class="panel">
                <h3>Общие Благословения</h3>
                <ol class="items-list">
                    {{#each blessings as |item|}}
                    <li class="item item-entry" data-item-id="{{item._id}}">
                        <img src="{{item.img}}"/>
                        <div class="item-name" style="{{#unless item.system.active}}color:#555; text-decoration:line-through;{{/unless}}">
                            {{item.name}}
                        </div>
                        {{#if ../isGM}}
                        <div class="item-controls">
                            <a class="item-edit"><i class="fas fa-edit"></i></a>
                            <a class="item-delete"><i class="fas fa-trash"></i></a>
                        </div>
                        {{/if}}
                    </li>
                    {{/each}}
                </ol>
            </div>
        </div>

        {{!-- === ВКЛАДКА: БИОГРАФИЯ === --}}
        <div class="tab biography" data-group="primary" data-tab="biography">
            <div class="sheet-body grid-2col">
                <div class="panel">
                    <h3>Внешность</h3>
                    <div class="editor-box small">
                        {{editor system.details.appearance target="system.details.appearance" button=true owner=owner editable=editable}}
                    </div>
                </div>
                <div class="panel">
                    <h3>Характер</h3>
                    <div class="editor-box small">
                        {{editor system.details.personality target="system.details.personality" button=true owner=owner editable=editable}}
                    </div>
                </div>
            </div>
            <div class="panel" style="margin-top:10px;">
                <h3>Цели</h3>
                <div class="editor-box small">
                    {{editor system.details.goals target="system.details.goals" button=true owner=owner editable=editable}}
                </div>
            </div>
            <div class="panel" style="margin-top:10px;">
                <h3>Полная История</h3>
                <div class="editor-box">
                    {{editor system.biography target="system.biography" button=true owner=true editable=true}}
                </div>
            </div>
        </div>

    </section>
</form>

<form class="{{cssClass}} monster-sheet" autocomplete="off" style="background: #111; color: #ccc; min-height: 650px; font-family: 'Signika', sans-serif;">
    
    {{!-- ХЕДЕР --}}
    <header class="sheet-header" style="display: flex; gap: 15px; padding: 15px; background: linear-gradient(135deg, #2a0a0a 0%, #000 100%); border-bottom: 2px solid #a00;">
        <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" style="width: 90px; height: 90px; border: 2px solid #a00; border-radius: 4px; object-fit: cover; background: #000; flex-shrink: 0;"/>
        
        <div style="flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
            
            {{!-- 1. Имя и Тип --}}
            <div style="display: flex; gap: 10px; align-items: center;">
                <input name="name" type="text" value="{{actor.name}}" placeholder="Имя Монстра" style="font-size: 26px; font-weight: bold; color: #fff; background: transparent; border: none; border-bottom: 1px solid #500; flex: 1; font-family: serif;"/>
                
                <select name="system.monsterType" style="background: #400; color: #faa; border: 1px solid #a00; font-weight: bold; padding: 2px;">
                    <option value="normal" {{#if (eq system.monsterType "normal")}}selected{{/if}}>Обычный</option>
                    <option value="elite" {{#if (eq system.monsterType "elite")}}selected{{/if}}>Элита</option>
                    <option value="boss" {{#if (eq system.monsterType "boss")}}selected{{/if}}>БОСС</option>
                </select>
            </div>

            {{!-- 2. Ранг, Этаж, Размер --}}
            <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">
                
                {{!-- Ранг (Селект) --}}
                <div style="display: flex; align-items: center; background: #200; border: 1px solid #600; border-radius: 3px; padding: 0 5px;">
                    <label style="font-size: 10px; color: #f88; margin-right: 5px; font-weight: bold;">РАНГ</label>
                    <select name="system.rank" style="background: transparent; border: none; color: #fff; font-weight: bold; width: auto; height: 20px;">
                        {{#each config.ranks as |label key|}}
                            <option value="{{key}}" {{#if (eq ../system.rank key)}}selected{{/if}}>{{key}}</option>
                        {{/each}}
                    </select>
                </div>

                {{!-- Этаж --}}
                <div style="display: flex; align-items: center; background: #222; border: 1px solid #444; border-radius: 3px; padding: 0 5px;">
                    <label style="font-size: 10px; color: #aaa; margin-right: 5px;">ЭТАЖ</label>
                    <input type="text" name="system.floor" value="{{system.floor}}" style="width: 40px; background: transparent; border: none; color: #fff; text-align: center; height: 20px;"/>
                </div>

                {{!-- Размер --}}
                <select name="system.subAttributes.size" style="background: #222; color: #ddd; border: 1px solid #444; height: 22px;">
                    {{selectOptions config.sizes selected=system.subAttributes.size labelAttr="label"}}
                </select>
            </div>

            {{!-- 3. Ресурсы --}}
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-top: 8px;">
                {{!-- HP --}}
                <div style="position: relative; height: 20px; background: #000; border: 1px solid #600; border-radius: 3px;">
                    <div style="position: absolute; height: 100%; width: {{hpPercent}}%; background: linear-gradient(90deg, #800, #c00);"></div>
                    <div style="position: absolute; width: 100%; text-align: center; line-height: 18px; color: #fff; font-size: 11px; font-weight: bold; text-shadow: 1px 1px 2px #000; display: flex; justify-content: center; gap: 2px;">
                        <span>HP:</span>
                        <input type="number" name="system.resources.hp.value" value="{{system.resources.hp.value}}" style="width: 40px; background: transparent; border: none; color: #fff; text-align: right; font-weight: bold; padding: 0;"/>
                        <span style="color: #aaa;">/ {{system.resources.hp.max}}</span>
                    </div>
                </div>

                {{!-- MP --}}
                <div style="position: relative; height: 20px; background: #000; border: 1px solid #336; border-radius: 3px;">
                    <div style="position: absolute; height: 100%; width: {{manaPercent}}%; background: linear-gradient(90deg, #004, #44a);"></div>
                    <div style="position: absolute; width: 100%; text-align: center; line-height: 18px; color: #fff; font-size: 11px; font-weight: bold; text-shadow: 1px 1px 2px #000; display: flex; justify-content: center; gap: 2px;">
                        <span>MP:</span>
                        <input type="number" name="system.resources.mana.value" value="{{system.resources.mana.value}}" style="width: 40px; background: transparent; border: none; color: #fff; text-align: right; font-weight: bold; padding: 0;"/>
                        <span style="color: #aaa;">/ {{system.resources.mana.max}}</span>
                    </div>
                </div>

                {{!-- DROP --}}
                <div style="display: flex; gap: 2px;">
                    <button type="button" class="roll-drop" style="background: #320; border: 1px solid #d90; color: #fb0; font-size: 10px; padding: 0 5px;" title="Бросить лут">
                        <i class="fas fa-gift"></i>
                    </button>
                    <input type="number" name="system.dropChance" value="{{system.dropChance}}" step="0.01" style="width: 40px; background: #111; border: 1px solid #444; color: #fb0; text-align: center; font-size: 11px;" title="Шанс (0.22)"/>
                </div>
            </div>
        </div>
    </header>

    {{!-- ТАБЫ --}}
    <nav class="sheet-tabs tabs" data-group="primary" style="background: #222; border-bottom: 1px solid #444; padding: 5px 10px;">
        <a class="item" data-tab="attributes">Характеристики</a>
        <a class="item" data-tab="combat">Бой</a>
        <a class="item" data-tab="inventory">Инвентарь</a>
        <a class="item" data-tab="notes">Заметки</a>
    </nav>

    <section class="sheet-body" style="padding: 10px; height: calc(100% - 160px); overflow-y: auto;">
        
        {{!-- 1. ХАРАКТЕРИСТИКИ --}}
        <div class="tab attributes" data-group="primary" data-tab="attributes">
            
            <button type="button" class="btn-initiative" style="width: 100%; margin-bottom: 15px; background: #311; border: 1px solid #a00; color: #f88; padding: 8px; font-weight: bold;">
                <i class="fas fa-bolt"></i> БРОСИТЬ ИНИЦИАТИВУ
            </button>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                
                {{!-- ЛЕВАЯ КОЛОНКА СТАТОВ --}}
                <div class="panel" style="background: rgba(0,0,0,0.3); border: 1px solid #444; padding: 8px; border-radius: 4px;">
                    <h3 style="color: #f66; font-size: 12px; border-bottom: 1px solid #633; margin-bottom: 5px;">ФИЗИЧЕСКИЕ</h3>
                    {{!-- Используем stat-row.hbs. isGM=true включает режим редактирования инпутов --}}
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.strength" label="Сила" val=system.subAttributes.strength sourceVal=sourceSystem.subAttributes.strength isGM=true}}
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.agility" label="Ловкость" val=system.subAttributes.agility sourceVal=sourceSystem.subAttributes.agility isGM=true}}
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.precision" label="Точность" val=system.subAttributes.precision sourceVal=sourceSystem.subAttributes.precision isGM=true}}
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.stamina" label="Выносливость" val=system.subAttributes.stamina sourceVal=sourceSystem.subAttributes.stamina isGM=true}}
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.fortitude" label="Стойкость" val=system.subAttributes.fortitude sourceVal=sourceSystem.subAttributes.fortitude isGM=true}}
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.boneDensity" label="Плотность" val=system.subAttributes.boneDensity sourceVal=sourceSystem.subAttributes.boneDensity isGM=true}}
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.naturalRegeneration" label="Регенерация" val=system.subAttributes.naturalRegeneration sourceVal=sourceSystem.subAttributes.naturalRegeneration isGM=true}}
                </div>

                {{!-- ПРАВАЯ КОЛОНКА СТАТОВ --}}
                <div class="panel" style="background: rgba(0,0,0,0.3); border: 1px solid #444; padding: 8px; border-radius: 4px;">
                    <h3 style="color: #66f; font-size: 12px; border-bottom: 1px solid #336; margin-bottom: 5px;">МЕНТАЛЬНЫЕ</h3>
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.cognition" label="Когнитивность" val=system.subAttributes.cognition sourceVal=sourceSystem.subAttributes.cognition isGM=true}}
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.willpower" label="Воля" val=system.subAttributes.willpower sourceVal=sourceSystem.subAttributes.willpower isGM=true}}
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.intuition" label="Интуиция" val=system.subAttributes.intuition sourceVal=sourceSystem.subAttributes.intuition isGM=true}}
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.soulPower" label="Сила Души" val=system.subAttributes.soulPower sourceVal=sourceSystem.subAttributes.soulPower isGM=true}}
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.spiritRecovery" label="Восст. Духа" val=system.subAttributes.spiritRecovery sourceVal=sourceSystem.subAttributes.spiritRecovery isGM=true}}
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.luck" label="Удача" val=system.subAttributes.luck sourceVal=sourceSystem.subAttributes.luck isGM=true}}
                    {{> "systems/dungeon-stone/templates/actor/parts/stat-row.hbs" key="subAttributes.presence" label="Присутствие" val=system.subAttributes.presence sourceVal=sourceSystem.subAttributes.presence isGM=true}}
                </div>

                {{!-- СОПРОТИВЛЕНИЯ (Нижний блок) --}}
                <div class="panel" style="grid-column: span 2; background: rgba(0,0,0,0.3); border: 1px solid #444; padding: 8px; border-radius: 4px;">
                    <h3 style="color: #aaa; font-size: 12px; border-bottom: 1px solid #555; margin-bottom: 5px;">СОПРОТИВЛЕНИЯ</h3>
                    
                    <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                        <div style="flex:1; display:flex; justify-content:space-between; background:#222; padding:3px 8px; border-radius:3px;">
                            <span>Физ. База</span>
                            <input class="direct-edit" type="number" name="system.resistances.physBase" value="{{system.resistances.physBase}}" style="width:40px; text-align:right; background:transparent; border:none; color:#fff; font-weight:bold;"/>
                        </div>
                        <div style="flex:1; display:flex; justify-content:space-between; background:#222; padding:3px 8px; border-radius:3px;">
                            <span>Маг. База</span>
                            <input class="direct-edit" type="number" name="system.resistances.magBase" value="{{system.resistances.magBase}}" style="width:40px; text-align:right; background:transparent; border:none; color:#fff; font-weight:bold;"/>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">
                        {{#each config.damageTypes as |label key|}}
                            <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding: 2px;">
                                <span style="font-size: 10px; color: #888;">{{label}}</span>
                                {{!-- Исправление цикла: используем lookup --}}
                                <input class="direct-edit" type="number" name="system.resistances.{{key}}" value="{{lookup ../system.resistances key}}" style="width: 30px; text-align: right; background: transparent; border: none; color: #fff; font-weight: bold; font-size: 11px;"/>
                            </div>
                        {{/each}}
                    </div>
                </div>
            </div>
        </div>

        {{!-- 2. БОЙ (Атаки и Магия) --}}
        <div class="tab combat" data-group="primary" data-tab="combat">
            
            {{!-- Оружие --}}
            <div class="panel" style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #a00; margin-bottom: 5px;">
                    <h3 style="color: #f88; margin: 0;">Атаки</h3>
                    <a class="item-create" data-type="weapon" style="color: #f88; cursor: pointer;"><i class="fas fa-plus"></i></a>
                </div>
                <div class="items-list" style="display: flex; flex-direction: column; gap: 4px;">
                    {{#each weapons as |item|}}
                        {{> "systems/dungeon-stone/templates/actor/parts/item-row.hbs" item=item isGM=true}}
                    {{/each}}
                </div>
            </div>

            {{!-- Магия --}}
            <div class="panel">
                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #44a; margin-bottom: 5px;">
                    <h3 style="color: #88f; margin: 0;">Магия и Способности</h3>
                    <div>
                        <a class="item-create" data-type="spell" style="color: #88f; margin-right: 8px; cursor: pointer;" title="Добавить Заклинание"><i class="fas fa-magic"></i></a>
                        <a class="item-create" data-type="feature" style="color: #8f8; cursor: pointer;" title="Добавить Способность"><i class="fas fa-star"></i></a>
                    </div>
                </div>
                <div class="items-list" style="display: flex; flex-direction: column; gap: 4px;">
                    {{#each spells as |item|}}
                        {{!-- Специальный вид для заклинаний (с кнопкой каста) --}}
                        <div class="item-row item" data-item-id="{{item._id}}" style="background: rgba(0,0,0,0.4); border: 1px solid #333; border-radius: 4px; padding: 4px; display: flex; align-items: center; gap: 8px;">
                            <img src="{{item.img}}" width="28" height="28" style="border: 1px solid #555; border-radius: 3px;"/>
                            <div style="flex: 1; font-weight: bold; color: #e0e0e0;">{{item.name}}</div>
                            <button class="cast-spell" style="background: #222; border: 1px solid #555; color: #ddd; font-size: 10px; padding: 2px 6px;">CAST</button>
                            <a class="item-edit" style="color:#666;"><i class="fas fa-edit"></i></a>
                            <a class="item-delete" style="color:#666;"><i class="fas fa-trash"></i></a>
                        </div>
                    {{/each}}
                    {{#each others as |item|}}
                        {{> "systems/dungeon-stone/templates/actor/parts/item-row.hbs" item=item isGM=true}}
                    {{/each}}
                </div>
            </div>
        </div>

        {{!-- 3. ИНВЕНТАРЬ --}}
        <div class="tab inventory" data-group="primary" data-tab="inventory">
            <div class="panel">
                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #d4af37; margin-bottom: 5px;">
                    <h3 style="color: #d4af37; margin: 0;">Лут</h3>
                    <a class="item-create" data-type="loot" style="color: #d4af37; cursor: pointer;"><i class="fas fa-plus"></i></a>
                </div>
                <div class="items-list" style="display: flex; flex-direction: column; gap: 4px;">
                    {{#each loot as |item|}}
                        {{> "systems/dungeon-stone/templates/actor/parts/item-row.hbs" item=item isGM=true}}
                    {{/each}}
                    {{#each consumables as |item|}}
                        {{> "systems/dungeon-stone/templates/actor/parts/item-row.hbs" item=item isGM=true}}
                    {{/each}}
                </div>
            </div>
        </div>

        {{!-- 4. ЗАМЕТКИ --}}
        <div class="tab notes" data-group="primary" data-tab="notes">
            <div class="editor-container" style="height: 100%; min-height: 400px;">
                {{editor enrichedBiography target="system.biography" button=true owner=owner editable=editable engine="prosemirror"}}
            </div>
        </div>

    </section>
</form>
